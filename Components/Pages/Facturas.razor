@page "/Facturas" 
@using blazorfactura.Components.Data 
@inject Servicios.ServicioControlador FacturasControlador 
@inject IJSRuntime JSRuntime 
@rendermode InteractiveServer

<div class="page-container">

<div class="d-flex justify-content-between mb-5 align-items-center" style="padding-bottom: 20px;">
    <div>
        <h2 class="mb-0" style="color: var(--c1);">Gestión de Facturas</h2>
        <p class="text-muted small mb-0">Administra tus ventas e inventario</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn shadow-sm text-dark bg-white border" @onclick="AlternarModoArchivo">
            <i class="bi @(modoArchivo ? "bi-unlock-fill" : "bi-lock-fill") me-2"></i> 
            @(modoArchivo ? "Salir del Archivo" : "Ver Archivo")
        </button>
        
        <a href="/" class="btn-secondary-custom px-4 py-2 text-decoration-none text-dark border-0 small shadow-sm">
            <i class="bi bi-arrow-left me-2"></i> Volver
        </a>
    </div>
</div>

@if (pidiendoPassword)
{
    <div class="row justify-content-center mb-5">
        <div class="col-md-6">
            <div class="card-box text-center border-warning" style="border-width: 2px;">
                <i class="bi bi-shield-lock display-4 text-warning mb-3"></i>
                <h4>Zona Restringida</h4>
                <p class="text-muted">Ingrese la contraseña para ver facturas archivadas.</p>
                
                <div class="input-group mb-3 mt-4 w-75 mx-auto">
                    <input type="password" @bind="passwordInput" class="form-control form-control-custom text-center" placeholder="Contraseña..." />
                    <button class="btn btn-warning text-white fw-bold" @onclick="VerificarPassword">Acceder</button>
                </div>
                @if (errorPassword)
                {
                    <p class="text-danger small fw-bold">Contraseña incorrecta.</p>
                }
            </div>
        </div>
    </div>
}
else if (modoArchivo)
{
    <div class="alert alert-warning d-flex align-items-center rounded-4 shadow-sm mb-4">
        <i class="bi bi-exclamation-triangle-fill fs-3 me-3"></i>
        <div>
            <strong>Estás en el Archivo Muerto.</strong>
            <div class="small">Estas facturas están ocultas de los reportes. Dale a "Restaurar" para devolverlas.</div>
        </div>
    </div>

    <div class="card-box p-0 overflow-hidden">
        @if(listaFacturas.Any())
        {
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light"><tr><th class="ps-4">Folio</th><th>Cliente</th><th>Total</th><th class="text-end pe-4">Acción</th></tr></thead>
                    <tbody>
                        @foreach(var f in listaFacturas) {
                            <tr style="background-color: #fffcf5;"> 
                                <td class="ps-4 fw-bold">#@f.Identificador</td>
                                <td>@f.NombreCliente <br><small class="text-muted">@f.Fecha.ToString("dd/MM/yyyy")</small></td>
                                <td class="fw-bold text-dark">$@f.Total.ToString("F2")</td>
                                <td class="text-end pe-4">
                                    <button class="btn btn-sm btn-success shadow-sm px-3 fw-bold" @onclick="() => DesarchivarFactura(f.Identificador)">
                                        <i class="bi bi-arrow-counterclockwise me-1"></i> Restaurar
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="text-center p-5 text-muted">No hay facturas archivadas.</div>
        }
    </div>
}
else
{
    <div class="row g-5">
        <div class="col-lg-4">
            <div class="card-box sticky-top" style="top: 20px; border-top: 5px solid var(--c1);">
                <h4 class="mb-4 text-center" style="color: var(--c1);">
                    @(facturaEditando == null ? "✨ Nueva Factura" : "✏️ Editando Cabecera")
                </h4>

                <div class="mb-3">
                    <label class="small text-muted fw-bold mb-1">Fecha de Emisión</label>
                    @if(facturaEditando != null) { <input type="date" @bind="fechaEditando" class="form-control form-control-custom" /> }
                    else { <input type="date" value="@nuevaFactura.Fecha.ToString("yyyy-MM-dd")" @onchange="@(async (e) => { nuevaFactura.Fecha = DateTime.Parse(e.Value.ToString()); await GuardarDatosFormulario(); })" class="form-control form-control-custom" /> }
                </div>
                <div class="mb-4">
                     <label class="small text-muted fw-bold mb-1">Cliente</label>
                     @if(facturaEditando != null) { <input type="text" @bind="clienteEditando" class="form-control form-control-custom" placeholder="Nombre del cliente" /> }
                     else { <input type="text" value="@nuevaFactura.NombreCliente" @onchange="@(async (e) => { nuevaFactura.NombreCliente = e.Value.ToString(); await GuardarDatosFormulario(); })" class="form-control form-control-custom" placeholder="Ej. Empresa S.A." /> }
                </div>

                @if (facturaEditando == null)
                {
                    <div class="bg-light p-3 rounded-4 mb-4 border">
                        <label class="small text-muted fw-bold mb-2 d-block text-center">Agregar Productos</label>
                        <div class="row g-2">
                            <div class="col-12"><input type="text" @bind="nuevoArticulo.Nombre" placeholder="Producto" class="form-control form-control-custom bg-white" /></div>
                            <div class="col-6"><input type="number" value="@tempPrecio" @onchange="@(async (e) => { if (decimal.TryParse(e.Value?.ToString(), out var p)) { tempPrecio = p; await GuardarDatosFormulario(); } })" placeholder="$ Precio" class="form-control form-control-custom bg-white" /></div>
                            <div class="col-6"><input type="number" value="@tempCantidad" @onchange="@(async (e) => { if (int.TryParse(e.Value?.ToString(), out var c)) { tempCantidad = c; await GuardarDatosFormulario(); } })" placeholder="Cant." class="form-control form-control-custom bg-white" /></div>
                            <div class="col-12 mt-2"><button @onclick="AgregarArticuloAFactura" class="btn-primary-custom w-100 py-2 small"><i class="bi bi-plus-lg me-1"></i> Agregar al Carrito</button></div>
                        </div>
                    </div>
                    @if (nuevaFactura.Articulos.Any())
                    {
                        <div class="mb-4">
                            <ul class="list-group list-group-flush mb-3">
                                @foreach(var art in nuevaFactura.Articulos) {
                                    <li class="list-group-item bg-transparent d-flex justify-content-between px-0 py-2 align-items-center">
                                        <div style="line-height: 1.2;"><span class="d-block fw-bold text-dark" style="font-size: 0.9rem;">@art.Nombre</span><small class="text-muted">@art.Cantidad x $@art.Precio</small></div>
                                        <div class="text-end"><strong class="text-success d-block small">$@art.Subtotal.ToString("F2")</strong><i class="bi bi-trash text-danger small" style="cursor:pointer" @onclick="() => EliminarArticuloTemporal(art)"></i></div>
                                    </li>
                                }
                            </ul>
                            <div class="d-flex justify-content-between align-items-center bg-light p-2 rounded-3"><span class="fw-bold text-muted">TOTAL:</span><h4 class="mb-0 fw-bold" style="color: var(--c1);">$@nuevaFactura.Total.ToString("F2")</h4></div>
                        </div>
                        <button class="btn-primary-custom w-100 shadow-sm py-3" @onclick="GuardarFactura"><i class="bi bi-save me-2"></i> Guardar Factura</button>
                    }
                }
                else
                {
                    <div class="d-flex gap-2"><button class="btn-secondary-custom w-50" @onclick="CancelarEdicionFactura">Cancelar</button><button class="btn-primary-custom w-50" @onclick="GuardarEdicionFactura">Guardar</button></div>
                }
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card-box h-100 p-0 overflow-hidden">
                <div class="p-4 bg-light border-bottom d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold text-dark">Historial de Facturas</h5>
                    <span class="badge bg-white text-dark border">@listaFacturas.Count registros</span>
                </div>
                
                @if(listaFacturas.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="small text-muted bg-light"><tr><th class="ps-4 py-3">Info Factura</th><th class="py-3">Contenido</th><th class="py-3 text-end pe-4">Acciones</th></tr></thead>
                            <tbody>
                                @foreach(var f in listaFacturas) {
                                    <tr>
                                        <td class="ps-4 align-top py-3" style="width: 25%;">
                                            <div class="mb-1"><span class="badge bg-light text-dark border mb-1">#@f.Identificador</span><br><strong class="text-dark">@f.NombreCliente</strong></div>
                                            <small class="text-muted d-block mb-1"><i class="bi bi-calendar-event me-1"></i> @f.Fecha.ToString("dd/MM/yyyy")</small>
                                            <h5 class="fw-bold mb-0" style="color: var(--c2);">$@f.Total.ToString("F2")</h5>
                                        </td>
                                        <td class="align-top py-3">
                                            <div class="card p-3 border-0 bg-light rounded-3">
                                                <ul class="list-unstyled mb-0">
                                                    @foreach (var art in f.Articulos) {
                                                        <li class="mb-3 border-bottom pb-2" style="border-color: rgba(0,0,0,0.05) !important;">
                                                            @if (articuloEditando?.Identificador == art.Identificador && facturaEditandoArticulo?.Identificador == f.Identificador) {
                                                                <div class="row g-1 align-items-center">
                                                                    <div class="col-4"><input type="text" class="form-control form-control-sm input-elegant" style="border-radius: 8px;" @bind="nombreArticuloEditando"></div>
                                                                    <div class="col-3"><input type="number" class="form-control form-control-sm input-elegant" style="border-radius: 8px;" @bind="precioArticuloEditando"></div>
                                                                    <div class="col-2"><input type="number" class="form-control form-control-sm input-elegant" style="border-radius: 8px;" @bind="cantidadArticuloEditando"></div>
                                                                    <div class="col-3 text-end d-flex justify-content-end gap-1">
                                                                        <button class="btn btn-sm shadow-sm text-white" style="background-color: var(--c2); border: none; border-radius: 8px; font-weight: 600;" title="Guardar" @onclick="@(() => GuardarEdicionArticulo(f.Identificador))"><i class="bi bi-check-lg"></i> OK</button>
                                                                        <button class="btn btn-sm shadow-sm" style="background-color: #eee; color: #666; border: none; border-radius: 8px;" title="Cancelar" @onclick="CancelarEdicionArticulo"><i class="bi bi-x-lg"></i></button>
                                                                    </div>
                                                                </div>
                                                            } else {
                                                                <div class="d-flex justify-content-between align-items-center">
                                                                    <div><span class="fw-bold text-dark" style="font-size: 0.9rem;">@art.Nombre</span><span class="text-muted small ms-2">(@art.Cantidad x $@art.Precio)</span></div>
                                                                    <div class="text-end"><strong class="text-dark small me-3 d-block">$@art.Subtotal.ToString("F2")</strong><button class="btn btn-sm me-1 mt-1" style="background-color: var(--white); color: var(--c1); border: 1px solid var(--c1); border-radius: 8px; font-size: 0.7rem; padding: 2px 8px;" @onclick="@(() => EditarArticulo(f, art))">✏️ Editar</button><button class="btn btn-sm mt-1" style="background-color: #fff5f5; color: #dc3545; border: 1px solid #ffc9c9; border-radius: 8px; font-size: 0.7rem; padding: 2px 8px;" @onclick="@(() => EliminarArticuloDeFactura(f.Identificador, art.Identificador))">🗑️ Borrar</button></div>
                                                                </div>
                                                            }
                                                        </li>
                                                    }
                                                </ul>
                                                <div class="mt-2 pt-2">
                                                    @if (facturaAgregandoArticulo?.Identificador == f.Identificador) {
                                                        <div class="row g-1 mt-2">
                                                            <div class="col-4"><input type="text" class="form-control form-control-sm" @bind="nuevoArticuloFactura.Nombre" placeholder="Nombre"></div>
                                                            <div class="col-3"><input type="number" class="form-control form-control-sm" @bind="nuevoArticuloFactura.Precio" placeholder="$"></div>
                                                            <div class="col-2"><input type="number" class="form-control form-control-sm" @bind="nuevoArticuloFactura.Cantidad" placeholder="#"></div>
                                                            <div class="col-3 text-end"><button class="btn btn-sm btn-primary p-1" @onclick="@(() => GuardarNuevoArticulo(f.Identificador))">Add</button></div>
                                                        </div>
                                                    } else {
                                                        <button class="btn w-100 border-dashed" style="border: 1px dashed var(--c1); color: var(--c1); background-color: white; border-radius: 10px; font-size: 0.85rem;" @onclick="@(() => MostrarFormularioAgregarArticulo(f))"><i class="bi bi-plus-circle me-1"></i> Agregar Artículo</button>
                                                    }
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-end pe-4 align-top py-3">
                                            <div class="d-flex flex-column gap-2 align-items-end">
                                                <button class="btn w-100 text-start shadow-sm" style="background-color: #fff3cd; border: 2px solid #ffecb5; color: #856404; border-radius: 12px; font-weight: 600;" title="Archivar para ocultar" @onclick="() => ArchivarFactura(f.Identificador)">
                                                    <i class="bi bi-archive-fill me-2"></i> Archivar
                                                </button>
                                                <button class="btn w-100 text-start shadow-sm" style="background-color: white; border: 2px solid var(--c1); color: var(--c1); border-radius: 12px; font-weight: 600;" title="Editar Cabecera" @onclick="() => EditarFactura(f)">
                                                    <i class="bi bi-pencil-square me-2"></i> Editar
                                                </button>
                                                <button class="btn w-100 text-start shadow-sm" style="background-color: #ffe5e5; border: 2px solid #ffb3b3; color: #d63384; border-radius: 12px; font-weight: 600;" title="Eliminar Factura" @onclick="() => EliminarFactura(f.Identificador)">
                                                    <i class="bi bi-trash me-2"></i> Borrar
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="text-center p-5 text-muted"><i class="bi bi-inbox display-1 opacity-25"></i><p class="mt-3">No hay facturas registradas aún.</p></div>
                }
            </div>
        </div>
    </div>
}
</div>

@code {
    private List<Factura> listaFacturas = new();
    private Factura nuevaFactura = new() { Fecha = DateTime.Now };
    private Articulo nuevoArticulo = new() { Cantidad = 1 };

  
    private decimal? tempPrecio;
    private int? tempCantidad;

    private Factura? facturaEditando = null;
    private DateTime fechaEditando;
    private string clienteEditando = "";
    private Articulo? articuloEditando = null;
    private Factura? facturaEditandoArticulo = null;
    private string nombreArticuloEditando = "";
    private decimal precioArticuloEditando = 0;
    private int cantidadArticuloEditando = 0;
    private Factura? facturaAgregandoArticulo = null;
    private Articulo nuevoArticuloFactura = new() { Cantidad = 1 };


    private bool modoArchivo = false;
    private bool pidiendoPassword = false;
    private string passwordInput = "";
    private bool errorPassword = false;
    private const string PASSWORD_SECRETA = "1234";

    protected override async Task OnInitializedAsync()
    {
        await CargarLista();
    }

    private async Task CargarLista()
    {
     
        if (modoArchivo)
        {
            listaFacturas = await FacturasControlador.ObtenerFacturasArchivadas();
        }
        else
        {
            listaFacturas = await FacturasControlador.ObtenerFacturas();
        }
    }


    private void AlternarModoArchivo()
    {
        if (modoArchivo)
        {
            modoArchivo = false;
            pidiendoPassword = false;
            passwordInput = "";
            CargarLista();
        }
        else
        {
            pidiendoPassword = true;
            errorPassword = false;
        }
    }

    private async Task VerificarPassword()
    {
        if (passwordInput == PASSWORD_SECRETA)
        {
            pidiendoPassword = false;
            modoArchivo = true;
            await CargarLista();
        }
        else
        {
            errorPassword = true;
        }
    }


    private async Task ArchivarFactura(int id)
    {
        await FacturasControlador.CambiarEstadoArchivo(id, true);
        await CargarLista();
    }

    private async Task DesarchivarFactura(int id)
    {
        await FacturasControlador.CambiarEstadoArchivo(id, false);
        await CargarLista();
    }


    private async Task AgregarArticuloAFactura()
    {
   
        if (!string.IsNullOrWhiteSpace(nuevoArticulo.Nombre) && tempPrecio > 0 && tempCantidad > 0)
        {
            nuevaFactura.Articulos.Add(new Articulo
            {
                Nombre = nuevoArticulo.Nombre,
                Precio = tempPrecio.Value,
                Cantidad = tempCantidad.Value
            });

          
            nuevoArticulo = new Articulo { Cantidad = 1 };
            tempPrecio = null;
            tempCantidad = null;

      
            await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "nuevoArticulo_Nombre");
            await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "nuevoArticulo_Precio");
            await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "nuevoArticulo_Cantidad");
        }
    }

    private void EliminarArticuloTemporal(Articulo articulo) => nuevaFactura.Articulos.Remove(articulo);

    private async Task GuardarFactura()
    {
        if (!string.IsNullOrWhiteSpace(nuevaFactura.NombreCliente) && nuevaFactura.Articulos.Any())
        {
            await FacturasControlador.AgregarFactura(nuevaFactura);
            await CargarLista();
            nuevaFactura = new Factura { Fecha = DateTime.Now };
            await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "nuevaFactura_Cliente");
        }
    }

    private async Task EliminarFactura(int identificador) { await FacturasControlador.EliminarFactura(identificador); await CargarLista(); }
    private void EditarFactura(Factura factura) { facturaEditando = factura; fechaEditando = factura.Fecha; clienteEditando = factura.NombreCliente; }
    private async Task GuardarEdicionFactura() { if (facturaEditando != null && !string.IsNullOrWhiteSpace(clienteEditando)) { facturaEditando.Fecha = fechaEditando; facturaEditando.NombreCliente = clienteEditando; await FacturasControlador.ActualizarFactura(facturaEditando); await CargarLista(); facturaEditando = null; } }
    private void CancelarEdicionFactura() => facturaEditando = null;
    private void EditarArticulo(Factura factura, Articulo articulo) { facturaEditandoArticulo = factura; articuloEditando = articulo; nombreArticuloEditando = articulo.Nombre; precioArticuloEditando = articulo.Precio; cantidadArticuloEditando = articulo.Cantidad; }
    private async Task GuardarEdicionArticulo(int facturaId) { if (articuloEditando != null && !string.IsNullOrWhiteSpace(nombreArticuloEditando)) { articuloEditando.Nombre = nombreArticuloEditando; articuloEditando.Precio = precioArticuloEditando; articuloEditando.Cantidad = cantidadArticuloEditando; await FacturasControlador.ActualizarArticulo(facturaId, articuloEditando); await CargarLista(); articuloEditando = null; facturaEditandoArticulo = null; } }
    private void CancelarEdicionArticulo() { articuloEditando = null; facturaEditandoArticulo = null; }
    private async Task EliminarArticuloDeFactura(int facturaId, int articuloId) { await FacturasControlador.EliminarArticulo(facturaId, articuloId); await CargarLista(); }
    private void MostrarFormularioAgregarArticulo(Factura factura) { facturaAgregandoArticulo = factura; nuevoArticuloFactura = new Articulo { Cantidad = 1 }; }
    private async Task GuardarNuevoArticulo(int facturaId) { if (!string.IsNullOrWhiteSpace(nuevoArticuloFactura.Nombre) && nuevoArticuloFactura.Precio > 0) { await FacturasControlador.AgregarArticuloAFacturaExistente(facturaId, nuevoArticuloFactura); await CargarLista(); facturaAgregandoArticulo = null; nuevoArticuloFactura = new Articulo { Cantidad = 1 }; } }
    private void CancelarAgregarArticulo() { facturaAgregandoArticulo = null; nuevoArticuloFactura = new Articulo { Cantidad = 1 }; }
    protected override async Task OnAfterRenderAsync(bool firstRender) { if (firstRender) { await CargarDatosFormulario(); StateHasChanged(); } }

    private async Task CargarDatosFormulario()
    {
        try
        {
            var f = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "nuevaFactura_Fecha"); if (!string.IsNullOrEmpty(f)) nuevaFactura.Fecha = DateTime.Parse(f);
            var c = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "nuevaFactura_Cliente"); if (!string.IsNullOrEmpty(c)) nuevaFactura.NombreCliente = c;
            var n = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "nuevoArticulo_Nombre"); if (!string.IsNullOrEmpty(n)) nuevaFactura.NombreCliente = n;


            var p = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "nuevoArticulo_Precio"); if (!string.IsNullOrEmpty(p)) tempPrecio = decimal.Parse(p);
            var q = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "nuevoArticulo_Cantidad"); if (!string.IsNullOrEmpty(q)) tempCantidad = int.Parse(q);
        }
        catch { }
    }

    private async Task GuardarDatosFormulario()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "nuevaFactura_Fecha", nuevaFactura.Fecha.ToString("yyyy-MM-dd"));
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "nuevaFactura_Cliente", nuevaFactura.NombreCliente ?? "");
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "nuevoArticulo_Nombre", nuevoArticulo.Nombre ?? "");
            if (tempPrecio.HasValue) await JSRuntime.InvokeVoidAsync("localStorage.setItem", "nuevoArticulo_Precio", tempPrecio.ToString());
            if (tempCantidad.HasValue) await JSRuntime.InvokeVoidAsync("localStorage.setItem", "nuevoArticulo_Cantidad", tempCantidad.ToString());
        }
        catch { }
    }
}