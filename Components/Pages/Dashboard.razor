@page "/dashboard"
@using blazorfactura.Components.Data
@inject blazorfactura.Components.Servicios.ServicioControlador Controlador
@rendermode InteractiveServer

<div class="container pb-5">
    <div class="d-flex justify-content-between align-items-center mb-4 pt-4">
        <div>
            <h2 class="mb-1 fw-bold">Tablero de Inteligencia</h2>
            <p class="text-muted">Visión general del rendimiento del negocio.</p>
        </div>
        <span class="badge bg-light text-dark border p-2 rounded-pill">
            <i class="bi bi-calendar-check me-1"></i> Datos en tiempo real
        </span>
    </div>

    @if (cargando)
    {
        <div class="text-center p-5 card-elegant">
            <div class="spinner-border" style="color: var(--c1); width: 3rem; height: 3rem;" role="status"></div>
            <p class="mt-3 text-muted fw-bold">Procesando millones de datos...</p>
        </div>
    }
    else
    {
        <div class="row mb-4 g-4">
            <div class="col-md-4">
                <div class="card-elegant text-white p-4 position-relative overflow-hidden" style="background: var(--grad-c1);">
                    <i class="bi bi-currency-dollar position-absolute" style="font-size: 8rem; opacity: 0.1; right: -20px; top: -20px;"></i>
                    <h5 class="opacity-75 mb-1">Ingresos Totales</h5>
                    <h2 class="display-5 fw-bold mb-0">$@datos.IngresosTotales.ToString("N0")</h2>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card-elegant text-white p-4 position-relative overflow-hidden" style="background: var(--grad-c2);">
                    <i class="bi bi-cart-check-fill position-absolute" style="font-size: 8rem; opacity: 0.1; right: -20px; top: -20px;"></i>
                    <h5 class="opacity-75 mb-1">Ventas Totales</h5>
                    <h2 class="display-5 fw-bold mb-0">@datos.TotalArticulosVendidos <span class="fs-5">items</span></h2>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card-elegant text-white p-4 position-relative overflow-hidden" style="background: var(--grad-c3);">
                    <i class="bi bi-receipt position-absolute" style="font-size: 8rem; opacity: 0.2; right: -20px; top: -20px; color: #555;"></i>
                    <h5 style="color: #555;" class="mb-1 fw-bold">Ticket Promedio</h5>
                    <h2 class="display-5 fw-bold mb-0" style="color: #333;">$@datos.TicketPromedio.ToString("N2")</h2>
                </div>
            </div>
        </div>

        <h4 class="mb-3">Análisis Detallado</h4>
        <div class="card-elegant p-0 overflow-hidden">
            <div class="accordion list-group list-group-flush" id="dashboardAccordion">
                <style>
                    .accordion-button {
                        padding: 1.5rem 2rem;
                        font-size: 1.1rem;
                        color: #444;
                    }

                        .accordion-button:not(.collapsed) {
                            background-color: rgba(38, 178, 167, 0.05);
                            color: var(--c1);
                            box-shadow: inset 5px 0 0 var(--c1);
                        }

                        .accordion-button::after {
                            filter: grayscale(100%);
                        }

                        .accordion-button:not(.collapsed)::after {
                            filter: hue-rotate(160deg);
                        }

                    .accordion-body {
                        padding: 2rem;
                        background-color: #fcfcfc;
                    }

                    .kpi-icon {
                        font-size: 2rem;
                        margin-right: 15px;
                    }
                </style>

                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button @(idAbierto == 1 ? "" : "collapsed")" type="button" @onclick="() => Alternar(1)">
                            <i class="bi bi-box-seam-fill kpi-icon text-primary"></i>
                            <strong>¿Cuál es el artículo más vendido?</strong>
                        </button>
                    </h2>
                    <div class="accordion-collapse collapse @(idAbierto == 1 ? "show" : "")" style="@(idAbierto == 1 ? "display:block" : "display:none")">
                        <div class="accordion-body">
                            <div class="d-flex align-items-center p-4 rounded-4 text-white" style="background: var(--grad-c1);">
                                <i class="bi bi-trophy-fill display-4 me-4"></i>
                                <div>
                                    <h2 class="mb-1 fw-bold">@datos.ProductoMasVendido</h2>
                                    <p class="mb-0 opacity-75">El líder indiscutible en rotación de inventario.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button @(idAbierto == 2 ? "" : "collapsed")" type="button" @onclick="() => Alternar(2)">
                            <i class="bi bi-calendar-week-fill kpi-icon text-warning"></i>
                            <strong>¿En cuál mes se vende más?</strong>
                        </button>
                    </h2>
                    <div class="accordion-collapse collapse @(idAbierto == 2 ? "show" : "")" style="@(idAbierto == 2 ? "display:block" : "display:none")">
                        <div class="accordion-body">
                            <div class="d-flex align-items-center p-4 rounded-4 text-white" style="background: var(--grad-c2);">
                                <i class="bi bi-sun-fill display-4 me-4"></i>
                                <div>
                                    <h2 class="mb-1 fw-bold">@datos.MesMejorVenta</h2>
                                    <p class="mb-0 opacity-75">Históricamente, tu temporada más fuerte.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button @(idAbierto == 3 ? "" : "collapsed")" type="button" @onclick="() => Alternar(3)">
                            <i class="bi bi-person-hearts kpi-icon text-danger"></i>
                            <strong>¿Quién es nuestro mejor cliente?</strong>
                        </button>
                    </h2>
                    <div class="accordion-collapse collapse @(idAbierto == 3 ? "show" : "")" style="@(idAbierto == 3 ? "display:block" : "display:none")">
                        <div class="accordion-body">
                            <div class="d-flex align-items-center p-4 rounded-4 text-white" style="background: var(--grad-danger);">
                                <i class="bi bi-crown-fill display-4 me-4"></i>
                                <div>
                                    <h2 class="mb-1 fw-bold">@datos.ClienteVip</h2>
                                    <p class="mb-0 opacity-75">El cliente que más valor ha aportado a la empresa.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button @(idAbierto == 6 ? "" : "collapsed")" type="button" @onclick="() => Alternar(6)">
                            <i class="bi bi-arrow-down-circle-fill kpi-icon text-secondary"></i>
                            <strong>¿Cuál es el artículo que menos se vende?</strong>
                        </button>
                    </h2>
                    <div class="accordion-collapse collapse @(idAbierto == 6 ? "show" : "")" style="@(idAbierto == 6 ? "display:block" : "display:none")">
                        <div class="accordion-body">
                            <div class="d-flex align-items-center p-4 rounded-4 bg-secondary text-white">
                                <i class="bi bi-recycle display-4 me-4"></i>
                                <div>
                                    <h2 class="mb-1 fw-bold">@datos.ProductoMenosVendido</h2>
                                    <p class="mb-0 opacity-75">Atención: Producto con muy baja rotación.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    }
</div>

@code {
    private DashboardDatos datos = new DashboardDatos();
    private bool cargando = true;
    private int idAbierto = 0;

    protected override async Task OnInitializedAsync()
    {
        datos = await Controlador.ObtenerDashboard();
        cargando = false;
    }

    private void Alternar(int id)
    {
        if (idAbierto == id) idAbierto = 0;
        else idAbierto = id;
    }
}