@page "/reportes"
@using blazorfactura.Components.Data
@inject Servicios.ServicioControlador FacturasControlador
@rendermode InteractiveServer
@inject IJSRuntime JSRuntime

<div class="page-container">
    <div class="text-center mb-5">
        <h2>Reportes Financieros</h2>
    </div>

    <div class="card-box py-4 mb-5">
        <div class="row align-items-end g-3 justify-content-center">
            <div class="col-md-3">
                <label class="form-label fw-bold text-muted small">Año</label>
                <input type="number" @bind="anioSeleccionado" class="form-control form-control-custom" placeholder="2024" />
            </div>
            <div class="col-md-4">
                <label class="form-label fw-bold text-muted small">Cliente (Opcional)</label>
                <select @bind="clienteSeleccionado" class="form-select form-select-custom">
                    <option value="">-- Todos --</option>
                    @foreach (var cliente in listaClientes)
                    {
                        <option value="@cliente">@cliente</option>
                    }
                </select>
            </div>
            <div class="col-md-3">
                <button @onclick="GenerarReporte" class="btn-primary-custom w-100">Buscar</button>
            </div>
        </div>
    </div>

    @if (reporteMostrado)
    {
        @if (reportePorMes.Any(m => m.Facturas.Any()))
        {
            <div class="row g-4">
                @foreach (var mes in reportePorMes.OrderBy(m => m.NumeroMes))
                {
                    @if (mes.Facturas.Any())
                    {
                        <div class="col-md-6">
                            <div class="card-box h-100 p-4 border-start border-4" style="border-color: var(--c1) !important; border-radius: 15px;">
                                <div class="d-flex justify-content-between mb-3">
                                    <h4 class="mb-0">@mes.NombreMes</h4>
                                    <span class="badge bg-light text-dark">@mes.Facturas.Count facturas</span>
                                </div>
                                <h3 class="fw-bold text-end" style="color: var(--c2);">$@mes.TotalMes.ToString("N2")</h3>
                                <hr class="opacity-25">
                                <small class="text-muted d-block">Detalle:</small>
                                <ul class="list-unstyled small text-muted mt-2">
                                    @foreach (var f in mes.Facturas.Take(3))
                                    {
                                        <li>#@f.Identificador - $@f.Total.ToString("N2") (@f.NombreCliente)</li>
                                    }
                                    @if (mes.Facturas.Count > 3)
                                    {
                                        <li>... y @(mes.Facturas.Count - 3) más</li>
                                    }
                                </ul>
                            </div>
                        </div>
                    }
                }
            </div>

            <div class="card-box mt-5 text-center bg-dark text-white">
                <h4 class="text-white-50">Gran Total @anioSeleccionado</h4>
                <h1 class="display-3 fw-bold text-white">$@totalAnual.ToString("N2")</h1>
            </div>
        }
        else
        {
            <div class="text-center text-muted py-5">
                <i class="bi bi-folder-x display-1"></i>
                <p class="mt-3">No se encontraron datos.</p>
            </div>
        }
    }
</div>

@code {

    private int anioSeleccionado = DateTime.Now.Year;
    private List<ReporteMes> reportePorMes = new();
    private bool reporteMostrado = false;
    private decimal totalAnual = 0;
    private int totalFacturas = 0;
    private string clienteSeleccionado = "";
    private List<string> listaClientes = new();

    protected override async Task OnInitializedAsync()
    {
        var todasLasFacturas = await FacturasControlador.ObtenerFacturas();
        if (todasLasFacturas != null)
        {
            listaClientes = todasLasFacturas.Select(f => f.NombreCliente).Distinct().OrderBy(n => n).ToList();
        }
    }

    private async Task GenerarReporte()
    {
        await JSRuntime.InvokeVoidAsync("localStorage.setItem", "reporte_anio", anioSeleccionado.ToString());
        var todas = await FacturasControlador.ObtenerFacturas();
        var query = todas.Where(f => f.Fecha.Year == anioSeleccionado);
        if (!string.IsNullOrEmpty(clienteSeleccionado)) query = query.Where(f => f.NombreCliente == clienteSeleccionado);
        var facturasDelAnio = query.ToList();

        reportePorMes.Clear();
        for (int mes = 1; mes <= 12; mes++)
        {
            var facturasDelMes = facturasDelAnio.Where(f => f.Fecha.Month == mes).ToList();
            reportePorMes.Add(new ReporteMes { NumeroMes = mes, NombreMes = ObtenerNombreMes(mes), Facturas = facturasDelMes, TotalMes = facturasDelMes.Sum(f => f.Total) });
        }
        totalAnual = reportePorMes.Sum(m => m.TotalMes);
        totalFacturas = facturasDelAnio.Count;
        reporteMostrado = true;
    }

    private string ObtenerNombreMes(int mes) => mes switch { 1 => "Enero", 2 => "Febrero", 3 => "Marzo", 4 => "Abril", 5 => "Mayo", 6 => "Junio", 7 => "Julio", 8 => "Agosto", 9 => "Septiembre", 10 => "Octubre", 11 => "Noviembre", 12 => "Diciembre", _ => "" };
    private class ReporteMes { public int NumeroMes { get; set; } public string NombreMes { get; set; } = ""; public List<Factura> Facturas { get; set; } = new(); public decimal TotalMes { get; set; } }

    protected override async Task OnAfterRenderAsync(bool firstRender) { if (firstRender) { await CargarAnioSeleccionado(); StateHasChanged(); } }
    private async Task CargarAnioSeleccionado() { try { var a = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "reporte_anio"); if (!string.IsNullOrEmpty(a)) anioSeleccionado = int.Parse(a); } catch { } }
}