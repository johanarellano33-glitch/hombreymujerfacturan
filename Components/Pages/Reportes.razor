@page "/reportes"
@using blazorfactura.Components.Data
@inject Servicios.ServicioControlador FacturasControlador
@rendermode InteractiveServer

<h3>Reportes de Facturas</h3>

<div>
    <label>Seleccionar Año:</label>
    <input type="number" @bind="anioSeleccionado" placeholder="2024" min="2000" max="2100" />

    <label style="margin-left: 15px;">Seleccionar Cliente:</label>
    <select @bind="clienteSeleccionado">
        <option value="">-- Todos los Clientes --</option>
        @if (listaClientes.Any())
        {
            @foreach (var cliente in listaClientes)
            {
                <option value="@cliente">@cliente</option>
            }
        }
    </select>
    <button @onclick="GenerarReporte" style="margin-left: 15px;">Generar Reporte</button>
</div>

<hr />

@if (reporteMostrado)
{
    <h4>
        Reporte del Año @anioSeleccionado
        @if (!string.IsNullOrEmpty(clienteSeleccionado))
        {
            <span> para el cliente: <strong>@clienteSeleccionado</strong></span>
        }
    </h4>
    @if (reportePorMes.Any(m => m.Facturas.Any()))
    {
        @foreach (var mes in reportePorMes.OrderBy(m => m.NumeroMes))
        {
            @if (mes.Facturas.Any())
            {
                <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 15px;">
                    <h5>@mes.NombreMes</h5>

                    <ul>
                        @foreach (var factura in mes.Facturas)
                        {
                            <li>
                                Factura #@factura.Identificador - @factura.Fecha.ToString("dd/MM/yyyy")
                                - Cliente: @factura.NombreCliente
                                - Total: $@factura.Total.ToString("F2")
                            </li>
                        }
                    </ul>
                    <p><strong>Total del mes: $@mes.TotalMes.ToString("F2")</strong></p>
                    <p>Número de facturas: @mes.Facturas.Count</p>
                </div>
            }
        }

        <div style="border: 2px solid #000; padding: 15px; background-color: #f0f0f0;">
            <h4>
                Total del Año @anioSeleccionado
                @if (!string.IsNullOrEmpty(clienteSeleccionado))
                {
                    <span> (Cliente: @clienteSeleccionado)</span>
                }
                : $@totalAnual.ToString("F2")
            </h4>
            <p>Total de facturas: @totalFacturas</p>
        </div>
    }
    else
    {
        <p>
            No hay facturas registradas para el año @anioSeleccionado
            @if (!string.IsNullOrEmpty(clienteSeleccionado))
            {
                <span> con el cliente @clienteSeleccionado</span>
            }
            .
        </p>
    }
}
<a href="Facturas">Facturas</a>

@code {
    private int anioSeleccionado = DateTime.Now.Year;
    private List<ReporteMes> reportePorMes = new();
    private bool reporteMostrado = false;
    private decimal totalAnual = 0;
    private int totalFacturas = 0;

    
    private string clienteSeleccionado = "";
    private List<string> listaClientes = new();
   

    
    protected override async Task OnInitializedAsync()
    {
        var todasLasFacturas = await FacturasControlador.ObtenerFacturas();
        if (todasLasFacturas != null)
        {
            listaClientes = todasLasFacturas
                .Select(f => f.NombreCliente)
                .Distinct()
                .OrderBy(nombre => nombre)
                .ToList();
        }
    }
   

    private async Task GenerarReporte()
    {
        var todasLasFacturas = await FacturasControlador.ObtenerFacturas();

       
        IEnumerable<Factura> facturasFiltradas = todasLasFacturas;

     
        if (!string.IsNullOrEmpty(clienteSeleccionado))
        {
            facturasFiltradas = facturasFiltradas
                .Where(f => f.NombreCliente == clienteSeleccionado);
        }

 
        var facturasDelAnio = facturasFiltradas
            .Where(f => f.Fecha.Year == anioSeleccionado)
            .ToList();
      
 
        reportePorMes.Clear();

        for (int mes = 1; mes <= 12; mes++)
        {
            var facturasDelMes = facturasDelAnio
                .Where(f => f.Fecha.Month == mes)
                .ToList();

            reportePorMes.Add(new ReporteMes
            {
                NumeroMes = mes,
                NombreMes = ObtenerNombreMes(mes),
                Facturas = facturasDelMes,
                TotalMes = facturasDelMes.Sum(f => f.Total)
            });
        }

        totalAnual = reportePorMes.Sum(m => m.TotalMes);
        totalFacturas = facturasDelAnio.Count;
        reporteMostrado = true;
    }

    private string ObtenerNombreMes(int mes)
    {
        return mes switch
        {
            1 => "Enero",
            2 => "Febrero",
            3 => "Marzo",
            4 => "Abril",
            5 => "Mayo",
            6 => "Junio",
            7 => "Julio",
            8 => "Agosto",
            9 => "Septiembre",
            10 => "Octubre",
            11 => "Noviembre",
            12 => "Diciembre",
            _ => "Mes desconocido"
        };
    }

    private class ReporteMes
    {
        public int NumeroMes { get; set; }
        public string NombreMes { get; set; } = "";
        public List<Factura> Facturas { get; set; } = new();
        public decimal TotalMes { get; set; }
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await CargarAnioSeleccionado();
            StateHasChanged();
        }
    }

    private async Task CargarAnioSeleccionado()
    {
        try
        {
            var anioStr = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "reporte_anio");
            if (!string.IsNullOrEmpty(anioStr))
            {
                anioSeleccionado = int.Parse(anioStr);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando año: {ex.Message}");
        }
    }
}