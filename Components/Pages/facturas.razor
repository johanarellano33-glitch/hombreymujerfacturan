@page "/facturas"
@using blazorfactura.Components.Data
@inject Servicios.ServicioControlador FacturasControlador
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<h3>Sistema de Facturas</h3>

<h4>Nueva Factura</h4>

<div>
    <label>Fecha:</label>
    <input type="date" @bind="nuevaFactura.Fecha" @bind:format="yyyy-MM-dd" />
</div>

<div>
    <label>Nombre del Cliente:</label>
    <input type="text" @bind="nuevaFactura.NombreCliente" placeholder="Nombre del cliente" />
</div>

<h5>Agregar Artículos</h5>

<div>
    <label>Nombre del artículo:</label>
    <input type="text" @bind="nuevoArticulo.Nombre" placeholder="Nombre del artículo" />
</div>

<div>
    <label>Precio:</label>
    <input type="number" @bind="nuevoArticulo.Precio" placeholder="Precio" step="0.01" />
</div>

<div>
    <label>Cantidad:</label>
    <input type="number" @bind="nuevoArticulo.Cantidad" placeholder="Cantidad" />
</div>

<div>
    <button @onclick="AgregarArticuloAFactura">Agregar Artículo</button>
</div>

@if (nuevaFactura.Articulos.Any())
{
    <h5>Artículos agregados:</h5>
    <ul>
        @foreach (var art in nuevaFactura.Articulos)
        {
            <li>
                @art.Nombre - Precio: $@art.Precio.ToString("F2") - Cantidad: @art.Cantidad - Subtotal: $@art.Subtotal.ToString("F2")
                <button @onclick="() => EliminarArticuloTemporal(art)">Eliminar</button>
            </li>
        }
    </ul>
    <p><strong>Total de la factura: $@nuevaFactura.Total.ToString("F2")</strong></p>
}

<div>
    <button @onclick="GuardarFactura">Guardar Factura</button>
</div>

<hr />

<h4>Facturas Registradas</h4>

<h4>Facturas Registradas</h4>

@if (listaFacturas.Any())
{
    <ul> 
        @foreach (var factura in listaFacturas)
        {
            <li>
                <strong>Factura #@factura.Identificador</strong> - @factura.Fecha.ToString("dd/MM/yyyy") - Cliente: @factura.NombreCliente
                <button @onclick="() => EliminarFactura(factura.Identificador)">Eliminar</button>
                <ul>  
                    @foreach (var art in factura.Articulos)
                    {
                        <li>
                            @art.Nombre - Precio: $@art.Precio.ToString("F2") - Cantidad: @art.Cantidad - Subtotal: $@art.Subtotal.ToString("F2")
                        </li>
                    }
                    <li><strong>Total: $@factura.Total.ToString("F2")</strong></li>
                </ul> 
            </li>
        }
    </ul> 
}
else
{
    <p>No hay facturas registradas.</p>
}

@code {
    private List<Factura> listaFacturas = new();
    private Factura nuevaFactura = new() { Fecha = DateTime.Now };
    private Articulo nuevoArticulo = new() { Cantidad = 1 };

    protected override async Task OnInitializedAsync()
    {
        listaFacturas = await FacturasControlador.ObtenerFacturas();
    }

    private void AgregarArticuloAFactura()
    {
        if (!string.IsNullOrWhiteSpace(nuevoArticulo.Nombre) && nuevoArticulo.Precio > 0)
        {
            nuevaFactura.Articulos.Add(new Articulo
            {
                Nombre = nuevoArticulo.Nombre,
                Precio = nuevoArticulo.Precio,
                Cantidad = nuevoArticulo.Cantidad
            });

            nuevoArticulo = new Articulo { Cantidad = 1 };
        }
    }

    private void EliminarArticuloTemporal(Articulo articulo)
    {
        nuevaFactura.Articulos.Remove(articulo);
    }

    private async Task GuardarFactura()
    {
        if (!string.IsNullOrWhiteSpace(nuevaFactura.NombreCliente) &&
            nuevaFactura.Articulos.Any())
        {
            await FacturasControlador.AgregarFactura(nuevaFactura);
            listaFacturas = await FacturasControlador.ObtenerFacturas();
            nuevaFactura = new Factura { Fecha = DateTime.Now };

            Console.WriteLine("Factura guardada correctamente");
        }
    }

    private async Task EliminarFactura(int identificador)
    {
        await FacturasControlador.EliminarFactura(identificador);
        listaFacturas = await FacturasControlador.ObtenerFacturas();

        Console.WriteLine($"Factura {identificador} eliminada");
    }
}