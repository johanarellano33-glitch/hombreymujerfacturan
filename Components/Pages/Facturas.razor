@page "/Facturas"
@using blazorfactura.Components.Data
@inject Servicios.ServicioControlador FacturasControlador
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<h3>Sistema de Facturas</h3>

<h4>Nueva Factura</h4>

<div>
    <label>Fecha:</label>
    <input type="date" value="@nuevaFactura.Fecha.ToString("yyyy-MM-dd")" @onchange="@(async (e) => { nuevaFactura.Fecha = DateTime.Parse(e.Value.ToString()); await GuardarDatosFormulario(); })" />
</div>

<div>
    <label>Nombre del Cliente:</label>
    <input type="text" value="@nuevaFactura.NombreCliente" @onchange="@(async (e) => { nuevaFactura.NombreCliente = e.Value.ToString(); await GuardarDatosFormulario(); })" placeholder="Nombre del cliente" />
</div>

<h5>Agregar Artículos</h5>

<div>
    <label>Nombre del artículo:</label>
    <input type="text" value="@nuevoArticulo.Nombre" @onchange="@(async (e) => { nuevoArticulo.Nombre = e.Value.ToString(); await GuardarDatosFormulario(); })" placeholder="Nombre del artículo" />
</div>

<div>
    <label>Precio:</label>
    <input type="number" value="@nuevoArticulo.Precio" @onchange="@(async (e) => { if (decimal.TryParse(e.Value.ToString(), out var precio)) { nuevoArticulo.Precio = precio; await GuardarDatosFormulario(); } })" placeholder="Precio" step="0.01" />
</div>

<div>
    <label>Cantidad:</label>
    <input type="number" value="@nuevoArticulo.Cantidad" @onchange="@(async (e) => { if (int.TryParse(e.Value.ToString(), out var cantidad)) { nuevoArticulo.Cantidad = cantidad; await GuardarDatosFormulario(); } })" placeholder="Cantidad" />
</div>

<div>
    <button @onclick="AgregarArticuloAFactura">Agregar Artículo</button>
</div>

@if (nuevaFactura.Articulos.Any())
{
    <h5>Artículos agregados:</h5>
    <ul>
        @foreach (var art in nuevaFactura.Articulos)
        {
            <li>
                @art.Nombre - Precio: $@art.Precio.ToString("F2") - Cantidad: @art.Cantidad - Subtotal: $@art.Subtotal.ToString("F2")
                <button @onclick="() => EliminarArticuloTemporal(art)">Eliminar</button>
            </li>
        }
    </ul>
    <p><strong>Total de la factura: $@nuevaFactura.Total.ToString("F2")</strong></p>
}

<div>
    <button @onclick="GuardarFactura">Guardar Factura</button>
</div>

<hr />

<h4>Facturas Registradas</h4>

@if (listaFacturas.Any())
{
    <ul>
        @foreach (var factura in listaFacturas)
        {
            <li>
                @if (facturaEditando?.Identificador == factura.Identificador)
                {
                    <strong>Editando Factura #@factura.Identificador</strong>
                    <br />
                    <label>Fecha:</label>
                    <input type="date" @bind="fechaEditando" @bind:format="yyyy-MM-dd" />
                    <label>Cliente:</label>
                    <input type="text" @bind="clienteEditando" />
                    <button @onclick="GuardarEdicionFactura">Guardar</button>
                    <button @onclick="CancelarEdicionFactura">Cancelar</button>
                }
                else
                {
                    <span>
                        <strong>Factura #@factura.Identificador</strong>
                        @factura.Fecha.ToString("dd/MM/yyyy")
                        Cliente: @factura.NombreCliente
                    </span>
                    <button @onclick="@(() => EditarFactura(factura))">Editar</button>
                    <button @onclick="@(() => EliminarFactura(factura.Identificador))">Eliminar</button>
                }

                <ul>
                    @foreach (var art in factura.Articulos)
                    {
                        <li>
                            @if (articuloEditando?.Identificador == art.Identificador && facturaEditandoArticulo?.Identificador == factura.Identificador)
                            {
                                <input type="text" @bind="nombreArticuloEditando" placeholder="Nombre" />
                                <input type="number" @bind="precioArticuloEditando" step="0.01" placeholder="Precio" />
                                <input type="number" @bind="cantidadArticuloEditando" placeholder="Cantidad" />
                                <button @onclick="@(() => GuardarEdicionArticulo(factura.Identificador))">Guardar</button>
                                <button @onclick="CancelarEdicionArticulo">Cancelar</button>
                            }
                            else
                            {
                                <span>
                                    @art.Nombre
                                    Precio: $@art.Precio.ToString("F2")
                                    Cantidad: @art.Cantidad
                                    Subtotal: $@art.Subtotal.ToString("F2")
                                </span>
                                <button @onclick="@(() => EditarArticulo(factura, art))">Editar</button>
                                <button @onclick="@(() => EliminarArticuloDeFactura(factura.Identificador, art.Identificador))">Eliminar</button>
                            }
                        </li>
                    }
                    <li><strong>Total: $@factura.Total.ToString("F2")</strong></li>
                </ul>

                @if (facturaAgregandoArticulo?.Identificador == factura.Identificador)
                {
                    <div>
                        Agregar artículo:
                        <input type="text" @bind="nuevoArticuloFactura.Nombre" placeholder="Nombre" />
                        <input type="number" @bind="nuevoArticuloFactura.Precio" step="0.01" placeholder="Precio" />
                        <input type="number" @bind="nuevoArticuloFactura.Cantidad" placeholder="Cantidad" />
                        <button @onclick="@(() => GuardarNuevoArticulo(factura.Identificador))">Agregar</button>
                        <button @onclick="CancelarAgregarArticulo">Cancelar</button>
                    </div>
                }
                else
                {
                    <button @onclick="@(() => MostrarFormularioAgregarArticulo(factura))">+ Agregar Artículo</button>
                }
            </li>
        }
    </ul>
}
else
{
    <p>No hay facturas registradas.</p>
}
<a href="Reportes">Reportes</a>
@code {
    private List<Factura> listaFacturas = new();
    private Factura nuevaFactura = new() { Fecha = DateTime.Now };
    private Articulo nuevoArticulo = new() { Cantidad = 1 };

    private Factura? facturaEditando = null;
    private DateTime fechaEditando;
    private string clienteEditando = "";

    private Articulo? articuloEditando = null;
    private Factura? facturaEditandoArticulo = null;
    private string nombreArticuloEditando = "";
    private decimal precioArticuloEditando = 0;
    private int cantidadArticuloEditando = 0;

    private Factura? facturaAgregandoArticulo = null;
    private Articulo nuevoArticuloFactura = new() { Cantidad = 1 };

    protected override async Task OnInitializedAsync()
    {
        listaFacturas = await FacturasControlador.ObtenerFacturas();
    }

    private void AgregarArticuloAFactura()
    {
        if (!string.IsNullOrWhiteSpace(nuevoArticulo.Nombre) && nuevoArticulo.Precio > 0)
        {
            nuevaFactura.Articulos.Add(new Articulo
            {
                Nombre = nuevoArticulo.Nombre,
                Precio = nuevoArticulo.Precio,
                Cantidad = nuevoArticulo.Cantidad
            });

            nuevoArticulo = new Articulo { Cantidad = 1 };
        }
    }

    private void EliminarArticuloTemporal(Articulo articulo)
    {
        nuevaFactura.Articulos.Remove(articulo);
    }

    private async Task GuardarFactura()
    {
        if (!string.IsNullOrWhiteSpace(nuevaFactura.NombreCliente) &&
            nuevaFactura.Articulos.Any())
        {
            await FacturasControlador.AgregarFactura(nuevaFactura);
            listaFacturas = await FacturasControlador.ObtenerFacturas();
            nuevaFactura = new Factura { Fecha = DateTime.Now };

            Console.WriteLine("Factura guardada correctamente");
        }
    }

    private async Task EliminarFactura(int identificador)
    {
        await FacturasControlador.EliminarFactura(identificador);
        listaFacturas = await FacturasControlador.ObtenerFacturas();
        Console.WriteLine($"Factura {identificador} eliminada");
    }

    private void EditarFactura(Factura factura)
    {
        facturaEditando = factura;
        fechaEditando = factura.Fecha;
        clienteEditando = factura.NombreCliente;
    }

    private async Task GuardarEdicionFactura()
    {
        if (facturaEditando != null && !string.IsNullOrWhiteSpace(clienteEditando))
        {
            facturaEditando.Fecha = fechaEditando;
            facturaEditando.NombreCliente = clienteEditando;

            await FacturasControlador.ActualizarFactura(facturaEditando);
            listaFacturas = await FacturasControlador.ObtenerFacturas();

            facturaEditando = null;
            Console.WriteLine("Factura actualizada");
        }
    }

    private void CancelarEdicionFactura()
    {
        facturaEditando = null;
    }

    private void EditarArticulo(Factura factura, Articulo articulo)
    {
        facturaEditandoArticulo = factura;
        articuloEditando = articulo;
        nombreArticuloEditando = articulo.Nombre;
        precioArticuloEditando = articulo.Precio;
        cantidadArticuloEditando = articulo.Cantidad;
    }

    private async Task GuardarEdicionArticulo(int facturaId)
    {
        if (articuloEditando != null && !string.IsNullOrWhiteSpace(nombreArticuloEditando))
        {
            articuloEditando.Nombre = nombreArticuloEditando;
            articuloEditando.Precio = precioArticuloEditando;
            articuloEditando.Cantidad = cantidadArticuloEditando;

            await FacturasControlador.ActualizarArticulo(facturaId, articuloEditando);
            listaFacturas = await FacturasControlador.ObtenerFacturas();

            articuloEditando = null;
            facturaEditandoArticulo = null;
            Console.WriteLine("Artículo actualizado");
        }
    }

    private void CancelarEdicionArticulo()
    {
        articuloEditando = null;
        facturaEditandoArticulo = null;
    }

    private async Task EliminarArticuloDeFactura(int facturaId, int articuloId)
    {
        await FacturasControlador.EliminarArticulo(facturaId, articuloId);
        listaFacturas = await FacturasControlador.ObtenerFacturas();
    }

    private void MostrarFormularioAgregarArticulo(Factura factura)
    {
        facturaAgregandoArticulo = factura;
        nuevoArticuloFactura = new Articulo { Cantidad = 1 };
    }

    private async Task GuardarNuevoArticulo(int facturaId)
    {
        if (!string.IsNullOrWhiteSpace(nuevoArticuloFactura.Nombre) && nuevoArticuloFactura.Precio > 0)
        {
            await FacturasControlador.AgregarArticuloAFacturaExistente(facturaId, nuevoArticuloFactura);
            listaFacturas = await FacturasControlador.ObtenerFacturas();

            facturaAgregandoArticulo = null;
            nuevoArticuloFactura = new Articulo { Cantidad = 1 };
        }
    }

    private void CancelarAgregarArticulo()
    {
        facturaAgregandoArticulo = null;
        nuevoArticuloFactura = new Articulo { Cantidad = 1 };
    }
   

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await CargarDatosFormulario();
            StateHasChanged();
        }
    }

    private async Task CargarDatosFormulario()
    {
        try
        {
      
            var fechaStr = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "nuevaFactura_Fecha");
            if (!string.IsNullOrEmpty(fechaStr))
            {
                nuevaFactura.Fecha = DateTime.Parse(fechaStr);
            }

          
            var cliente = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "nuevaFactura_Cliente");
            if (!string.IsNullOrEmpty(cliente))
            {
                nuevaFactura.NombreCliente = cliente;
            }

   
            var nombreArt = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "nuevoArticulo_Nombre");
            if (!string.IsNullOrEmpty(nombreArt))
            {
                nuevoArticulo.Nombre = nombreArt;
            }

            var precioStr = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "nuevoArticulo_Precio");
            if (!string.IsNullOrEmpty(precioStr))
            {
                nuevoArticulo.Precio = decimal.Parse(precioStr);
            }

            var cantidadStr = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "nuevoArticulo_Cantidad");
            if (!string.IsNullOrEmpty(cantidadStr))
            {
                nuevoArticulo.Cantidad = int.Parse(cantidadStr);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando datos: {ex.Message}");
        }
    }

    private async Task GuardarDatosFormulario()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "nuevaFactura_Fecha", nuevaFactura.Fecha.ToString("yyyy-MM-dd"));
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "nuevaFactura_Cliente", nuevaFactura.NombreCliente ?? "");
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "nuevoArticulo_Nombre", nuevoArticulo.Nombre ?? "");
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "nuevoArticulo_Precio", nuevoArticulo.Precio.ToString());
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "nuevoArticulo_Cantidad", nuevoArticulo.Cantidad.ToString());
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error guardando datos: {ex.Message}");
        }
    }
}                       