@page "/Facturas"
@using blazorfactura.Components.Data
@inject Servicios.ServicioControlador FacturasControlador
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<h3>Sistema de Facturas</h3>

<h4>Nueva Factura</h4>

<div>
    <label>Fecha:</label>
    <input type="date" @bind="nuevaFactura.Fecha" @bind:format="yyyy-MM-dd" />
</div>

<div>
    <label>Nombre del Cliente:</label>
    <input type="text" @bind="nuevaFactura.NombreCliente" placeholder="Nombre del cliente" />
</div>

<h5>Agregar Artículos</h5>

<div>
    <label>Nombre del artículo:</label>
    <input type="text" @bind="nuevoArticulo.Nombre" placeholder="Nombre del artículo" />
</div>

<div>
    <label>Precio:</label>
    <input type="number" @bind="nuevoArticulo.Precio" placeholder="Precio" step="0.01" />
</div>

<div>
    <label>Cantidad:</label>
    <input type="number" @bind="nuevoArticulo.Cantidad" placeholder="Cantidad" />
</div>

<div>
    <button @onclick="AgregarArticuloAFactura">Agregar Artículo</button>
</div>

@if (nuevaFactura.Articulos.Any())
{
    <h5>Artículos agregados:</h5>
    <ul>
        @foreach (var art in nuevaFactura.Articulos)
        {
            <li>
                @art.Nombre - Precio: $@art.Precio.ToString("F2") - Cantidad: @art.Cantidad - Subtotal: $@art.Subtotal.ToString("F2")
                <button @onclick="() => EliminarArticuloTemporal(art)">Eliminar</button>
            </li>
        }
    </ul>
    <p><strong>Total de la factura: $@nuevaFactura.Total.ToString("F2")</strong></p>
}

<div>
    <button @onclick="GuardarFactura">Guardar Factura</button>
</div>


<h4>Facturas Registradas</h4>



@if (listaFacturas.Any())
{
    <ul> 
        @foreach (var factura in listaFacturas)
        {
            <li>
                <strong>Factura #@factura.Identificador</strong> - @factura.Fecha.ToString("dd/MM/yyyy") - Cliente: @factura.NombreCliente
                <button @onclick="() => EliminarFactura(factura.Identificador)">Eliminar</button>
                <ul>  
                    @foreach (var art in factura.Articulos)
                    {
                        <li>
                            @art.Nombre - Precio: $@art.Precio.ToString("F2") - Cantidad: @art.Cantidad - Subtotal: $@art.Subtotal.ToString("F2")
                        </li>
                    }
                    <li><strong>Total: $@factura.Total.ToString("F2")</strong></li>
                </ul> 
            </li>
        }
    </ul> 
}
else
{
    <p>No hay facturas registradas.</p>
}

@code {
    private List<Factura> listaFacturas = new();
    private Factura nuevaFactura = new() { Fecha = DateTime.Now };
    private Articulo nuevoArticulo = new() { Cantidad = 1 };
  
    private Factura? facturaEditando = null;
    private DateTime fechaEditando;
    private string clienteEditando = "";

    
    private Articulo? articuloEditando = null;
    private Factura? facturaEditandoArticulo = null;
    private string nombreArticuloEditando = "";
    private decimal precioArticuloEditando = 0;
    private int cantidadArticuloEditando = 0;

   
    private Factura? facturaAgregandoArticulo = null;
    private Articulo nuevoArticuloFactura = new() { Cantidad = 1 };
    protected override async Task OnInitializedAsync()
    {
        listaFacturas = await FacturasControlador.ObtenerFacturas();
    }

    private void AgregarArticuloAFactura()
    {
        if (!string.IsNullOrWhiteSpace(nuevoArticulo.Nombre) && nuevoArticulo.Precio > 0)
        {
            nuevaFactura.Articulos.Add(new Articulo
            {
                Nombre = nuevoArticulo.Nombre,
                Precio = nuevoArticulo.Precio,
                Cantidad = nuevoArticulo.Cantidad
            });

            nuevoArticulo = new Articulo { Cantidad = 1 };
        }
    }

    private void EliminarArticuloTemporal(Articulo articulo)
    {
        nuevaFactura.Articulos.Remove(articulo);
    }

    private async Task GuardarFactura()
    {
        if (!string.IsNullOrWhiteSpace(nuevaFactura.NombreCliente) &&
            nuevaFactura.Articulos.Any())
        {
            await FacturasControlador.AgregarFactura(nuevaFactura);
            listaFacturas = await FacturasControlador.ObtenerFacturas();
            nuevaFactura = new Factura { Fecha = DateTime.Now };

            Console.WriteLine("Factura guardada correctamente");
        }
    }

    private async Task EliminarFactura(int identificador)
    {
        await FacturasControlador.EliminarFactura(identificador);
        listaFacturas = await FacturasControlador.ObtenerFacturas();

        Console.WriteLine($"Factura {identificador} eliminada");
    }
    private void EditarFactura(Factura factura)
    {
        facturaEditando = factura;
        fechaEditando = factura.Fecha;
        clienteEditando = factura.NombreCliente;
    }

    private async Task GuardarEdicionFactura()
    {
        if (facturaEditando != null && !string.IsNullOrWhiteSpace(clienteEditando))
        {
            facturaEditando.Fecha = fechaEditando;
            facturaEditando.NombreCliente = clienteEditando;

            await FacturasControlador.ActualizarFactura(facturaEditando);
            listaFacturas = await FacturasControlador.ObtenerFacturas();

            facturaEditando = null;
            Console.WriteLine("Factura actualizada");
        }
    }
    private async Task CancelarEdicionFactura()
    {
        facturaEditando = null;
    }
    private void EditarArticulo(Factura factura, Articulo articulo)
    {
        facturaEditandoArticulo = factura;
        articuloEditando = articulo;
        nombreArticuloEditando = articulo.Nombre;
        precioArticuloEditando = articulo.Precio;
        cantidadArticuloEditando = articulo.Cantidad;
    }

    private async Task GuardarEdicionArticulo(int facturaId)
    {
        if (articuloEditando != null && !string.IsNullOrWhiteSpace(nombreArticuloEditando))
        {
            articuloEditando.Nombre = nombreArticuloEditando;
            articuloEditando.Precio = precioArticuloEditando;
            articuloEditando.Cantidad = cantidadArticuloEditando;

            await FacturasControlador.ActualizarArticulo(facturaId, articuloEditando);
            listaFacturas = await FacturasControlador.ObtenerFacturas();

            articuloEditando = null;
            facturaEditandoArticulo = null;
            Console.WriteLine("Artículo actualizado");
        }
    }

    private void CancelarEdicionArticulo()
    {
        articuloEditando = null;
        facturaEditandoArticulo = null;
    }

    private async Task EliminarArticuloDeFactura(int facturaId, int articuloId)
    {
        await FacturasControlador.EliminarArticulo(facturaId, articuloId);
        listaFacturas = await FacturasControlador.ObtenerFacturas();
    }
    private void MostrarFormularioAgregarArticulo(Factura factura)
    {
        facturaAgregandoArticulo = factura;
        nuevoArticuloFactura = new Articulo { Cantidad = 1 };
    }

    private async Task GuardarNuevoArticulo(int facturaId)
    {
        if (!string.IsNullOrWhiteSpace(nuevoArticuloFactura.Nombre) && nuevoArticuloFactura.Precio > 0)
        {
            await FacturasControlador.AgregarArticuloAFacturaExistente(facturaId, nuevoArticuloFactura);
            listaFacturas = await FacturasControlador.ObtenerFacturas();

            facturaAgregandoArticulo = null;
            nuevoArticuloFactura = new Articulo { Cantidad = 1 };
        }
    }

    private void CancelarAgregarArticulo()
    {
        facturaAgregandoArticulo = null;
        nuevoArticuloFactura = new Articulo { Cantidad = 1 };
    }

}